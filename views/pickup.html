<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pickup Request - BookSwap</title>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <!-- Theme CSS -->
  <link rel="stylesheet" href="/css/theme.css">
  
  <!-- Pickup Form CSS -->
  <link rel="stylesheet" href="/css/pickup-form.css">
  
  <!-- Enhanced Chatbot CSS -->
  <link rel="stylesheet" href="/css/chatbot.css">
  
  <style>
    /* NYC Navbar */
    .navbar {
      background: #6d56b0;
      color: var(--white);
      padding: var(--space-lg) var(--space-2xl);
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow-2xl);
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .navbar-brand {
      font-size: 2rem;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      font-family: var(--font-secondary);
    }

    .nav-links {
      list-style: none;
      display: flex;
      gap: var(--space-xl);
      padding: 0;
      margin: 0;
      align-items: center;
    }

    .nav-links li a {
      color: var(--white);
      text-decoration: none;
      font-weight: 500;
      padding: var(--space-sm) var(--space-md);
      border-radius: var(--radius-lg);
      transition: all var(--transition-normal);
    }
    
    .nav-links li a:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateY(-1px);
    }

    /* Hamburger Menu */
    .hamburger-menu {
      display: none;
      flex-direction: column;
      background: none;
      border: none;
      cursor: pointer;
      padding: var(--space-sm);
    }

    .hamburger-line {
      width: 25px;
      height: 3px;
      background: var(--white);
      margin: 2px 0;
      transition: var(--transition-normal);
      border-radius: var(--radius-sm);
    }

    /* Mobile styles */
    @media (max-width: 768px) {
      .hamburger-menu {
        display: flex;
      }

      .nav-links {
        position: fixed;
        top: 70px;
        right: -100%;
        width: 100%;
        height: calc(100vh - 70px);
        background: var(--gradient-dark);
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        padding-top: var(--space-2xl);
        transition: right var(--transition-smooth);
        z-index: 1000;
        backdrop-filter: blur(10px);
      }

      .nav-links.active {
        right: 0;
      }

      .nav-links li {
        margin: var(--space-lg) 0;
      }

      .nav-links li a {
        font-size: 1.2rem;
        padding: var(--space-lg) var(--space-2xl);
        display: block;
        text-align: center;
        width: 100%;
        border-radius: var(--radius-lg);
        transition: all var(--transition-normal);
        background: var(--glass-white);
      }

      .nav-links li a:hover {
        background: var(--glass-light);
        transform: translateX(5px);
      }

      .hamburger-menu.active .hamburger-line:nth-child(1) {
        transform: rotate(-45deg) translate(-5px, 6px);
      }

      .hamburger-menu.active .hamburger-line:nth-child(2) {
        opacity: 0;
      }

      .hamburger-menu.active .hamburger-line:nth-child(3) {
        transform: rotate(45deg) translate(-5px, -6px);
      }
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar">
    <div class="navbar-brand">
      🏙️📚 BookSwap
    </div>
    
    <!-- Navigation Links -->
    <ul class="nav-links" id="nav-links">
      <li><a href="/">Home</a></li>
      <li><a href="/add-book">Add Book</a></li>
      <li><a href="/gallery">Gallery</a></li>
      <li><a href="/dashboard">Dashboard</a></li>
      <li><a href="/profile">Profile</a></li>
      <li><a href="/Pickup">Pickup</a></li>
      <li><a href="/pickup-track">Track</a></li>
    </ul>
    
    <!-- Hamburger Menu Button -->
    <button class="hamburger-menu" id="hamburger-menu" aria-label="Menu">
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
    </button>
  </nav>

  <!-- Main Section with Form & Image -->
  <div class="pickup-wrapper">
    <!-- Pickup Form -->
    <section class="pickup-form-section card animate-slide-up">
      <h2 class="pickup-page-title">📦 Enhanced Pickup Request Form</h2>
      
      <!-- Book Selection Section -->
      <div class="book-selection">
        <h3>📚 Select Books for Pickup</h3>
        <div class="book-search">
          <input type="text" id="bookSearch" placeholder="🔍 Search available books...">
          <button type="button" id="searchBtn" class="search-btn">Search</button>
        </div>
        <div id="bookSuggestions" class="book-suggestions"></div>
        <div id="selectedBooks" class="selected-books"></div>
      </div>

      <form id="pickupForm" novalidate>
        <div class="form-group">
          <label for="pickupType">Pickup Type *</label>
          <select id="pickupType" name="pickupType" required>
            <option value="">Select pickup type</option>
            <option value="single">📖 Single Book</option>
            <option value="multiple">📚 Multiple Books</option>
            <option value="donation">💝 Donation Collection</option>
            <option value="swap">🔄 Book Swap</option>
          </select>
          <div class="error" id="pickupTypeError"></div>
        </div>

        <div class="form-group">
          <label for="bookTitle">Book Title(s) *</label>
          <textarea id="bookTitle" name="bookTitle" rows="2" placeholder="Enter book titles (one per line for multiple books)" required></textarea>
          <div class="error" id="bookTitleError"></div>
        </div>

        <div class="form-group">
          <label for="userName">Your Full Name *</label>
          <input type="text" id="userName" name="userName" placeholder="Enter your full name" required>
          <div class="error" id="userNameError"></div>
        </div>

        <div class="form-group">
          <label for="email">Email Address *</label>
          <input type="email" id="email" name="email" placeholder="your@email.com" required>
          <div class="error" id="emailError"></div>
        </div>

        <div class="form-group">
          <label for="mobile">Mobile Number *</label>
          <input type="tel" id="mobile" name="mobile" placeholder="+91 XXXXX XXXXX" required>
          <div class="error" id="mobileError"></div>
        </div>

        <div class="form-group">
          <label for="pickupAddress">Complete Pickup Address *</label>
          <textarea id="pickupAddress" name="pickupAddress" rows="4" placeholder="Enter complete address including landmark" required></textarea>
          <div class="error" id="addressError"></div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="pickupDate">Preferred Date *</label>
            <input type="date" id="pickupDate" name="pickupDate" required>
            <div class="error" id="dateError"></div>
          </div>
          <div class="form-group">
            <label for="pickupTime">Preferred Time *</label>
            <select id="pickupTime" name="pickupTime" required>
              <option value="">Select time slot</option>
              <option value="09:00-12:00">🌅 Morning (9:00 AM - 12:00 PM)</option>
              <option value="12:00-15:00">🌞 Afternoon (12:00 PM - 3:00 PM)</option>
              <option value="15:00-18:00">🌇 Evening (3:00 PM - 6:00 PM)</option>
              <option value="18:00-21:00">🌙 Night (6:00 PM - 9:00 PM)</option>
            </select>
            <div class="error" id="timeError"></div>
          </div>
        </div>

        <div class="form-group">
          <label for="specialInstructions">Special Instructions</label>
          <textarea id="specialInstructions" name="specialInstructions" rows="3" placeholder="Any special instructions for pickup (optional)"></textarea>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="notifications" name="notifications" checked>
            📱 Send SMS notifications for pickup updates
          </label>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="terms" name="terms" required>
            ✅ I agree to the <a href="#" onclick="showTerms()">terms and conditions</a> *
          </label>
          <div class="error" id="termsError"></div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary btn-submit btn-lg">📦 Submit Pickup Request</button>
          <button type="button" class="btn btn-warning btn-save-draft btn-lg" onclick="saveDraft()">💾 Save as Draft</button>
        </div>
      </form>

      <!-- Confirmation Message -->
      <div id="confirmationMsg" class="confirmation hidden">
        <h3>✅ Pickup Request Submitted!</h3>
        <p>Thank you <span id="confirmName"></span>. We've received your request to pick up <strong><span id="confirmBook"></span></strong>.</p>
        <div class="tracking-info">
          <div class="tracking-id-display">
            <h4>📋 Your Tracking ID:</h4>
            <div class="tracking-id" id="trackingIdDisplay">PU123456789ABC</div>
            <div class="tracking-actions">
              <button type="button" class="btn btn-primary" onclick="copyTrackingId()">📋 Copy ID</button>
              <button type="button" class="btn btn-secondary" onclick="trackPickup()">🔍 Track Pickup</button>
            </div>
          </div>
        </div>
        <p>📧 Confirmation sent to <span id="confirmEmail"></span>.</p>
        <p class="important-note">⚠️ <strong>Important:</strong> Save your tracking ID to check pickup status anytime!</p>
      </div>
    </section>

    <!-- Illustration Right Side -->
    <div class="pickup-image"></div>
  </div>

  <!-- Footer -->
  <footer>
    <p>&copy; 2025 BookSwap Platform | Built with ❤️ by Bhavana G M</p>
  </footer>

  <!-- Enhanced Pickup Validation Script -->
  <script src="/js/pickup-validation.js"></script>
  
  <!-- Core Functionality Script -->
  <script>
    // Authentication Check
    fetch('/api/current-user')
      .then(response => {
        if (!response.ok) {
          window.location.href = '/login';
        }
      })
      .catch(() => {
        window.location.href = '/login';
      });

    // Navigation Menu Toggle - Index Page Style
    const hamburgerMenu = document.getElementById('hamburger-menu');
    const navLinks = document.getElementById('nav-links');
    
    if (hamburgerMenu && navLinks) {
      hamburgerMenu.addEventListener('click', function() {
        // Toggle active class on hamburger button
        hamburgerMenu.classList.toggle('active');
        
        // Toggle active class on navigation menu
        navLinks.classList.toggle('active');
      });
      
      // Close menu when clicking on a link (mobile)
      const menuLinks = navLinks.querySelectorAll('a');
      menuLinks.forEach(link => {
        link.addEventListener('click', () => {
          hamburgerMenu.classList.remove('active');
          navLinks.classList.remove('active');
        });
      });
      
      // Close menu when clicking outside (mobile)
      document.addEventListener('click', function(event) {
        const isClickInsideNav = navLinks.contains(event.target);
        const isClickOnHamburger = hamburgerMenu.contains(event.target);
        
        if (!isClickInsideNav && !isClickOnHamburger && navLinks.classList.contains('active')) {
          hamburgerMenu.classList.remove('active');
          navLinks.classList.remove('active');
        }
      });
    }

    // Enhanced Book Selection Features
    let availableBooks = [];
    let selectedBooks = [];
    
    // Load books from database
    async function loadAvailableBooks() {
      try {
        const response = await fetch('/api/books?showAll=true');
        const data = await response.json();
        
        if (data.success && Array.isArray(data.books)) {
          availableBooks = data.books.map(book => ({
            id: book._id,
            title: book.title || 'Unknown Title',
            author: book.author || 'Unknown Author',
            genre: book.genre || 'Unknown Genre',
            owner: book.userId?.username || 'Unknown',
            type: book.type || 'book'
          }));
          console.log(`✅ Loaded ${availableBooks.length} books`);
        } else {
          // Fallback books
          availableBooks = [
            { title: "Atomic Habits", author: "James Clear", genre: "Self-Help" },
            { title: "The Alchemist", author: "Paulo Coelho", genre: "Fiction" },
            { title: "Rich Dad Poor Dad", author: "Robert Kiyosaki", genre: "Finance" }
          ];
        }
      } catch (error) {
        console.error('Error loading books:', error);
        availableBooks = [
          { title: "Atomic Habits", author: "James Clear", genre: "Self-Help" },
          { title: "The Alchemist", author: "Paulo Coelho", genre: "Fiction" }
        ];
      }
    }

    // Book Search & Selection Functions
    function initializeBookSearch() {
      const searchBtn = document.getElementById('searchBtn');
      const bookSearch = document.getElementById('bookSearch');
      
      if (searchBtn) searchBtn.addEventListener('click', searchBooks);
      if (bookSearch) {
        bookSearch.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') searchBooks();
        });
      }
    }

    function searchBooks() {
      const query = document.getElementById('bookSearch').value.toLowerCase().trim();
      const suggestions = document.getElementById('bookSuggestions');
      
      if (!query) {
        suggestions.innerHTML = '';
        return;
      }

      const filteredBooks = availableBooks.filter(book => 
        book.title.toLowerCase().includes(query) || 
        book.author.toLowerCase().includes(query) ||
        book.genre.toLowerCase().includes(query)
      );

      suggestions.innerHTML = filteredBooks.length ? 
        filteredBooks.map(book => `
          <div class="book-suggestion animate-fade-in" onclick="selectBook('${book.title}', '${book.author}', '${book.id || ''}')">
            <strong>${book.title}</strong><br>
            <small>by ${book.author} • ${book.genre}</small>
          </div>
        `).join('') :
        `<div style="padding: var(--space-lg); text-align: center; color: var(--gray-500);">
          📚 No books found matching "${query}"</div>`;
    }

    function selectBook(title, author, bookId = '') {
      const bookInfo = `${title} by ${author}`;
      
      if (selectedBooks.find(book => book.info === bookInfo)) {
        showAlert('warning', 'Book already selected!');
        return;
      }

      selectedBooks.push({ info: bookInfo, id: bookId, title, author });
      updateSelectedBooks();
      updateBookTitleField();
      
      if (bookId) {
        const url = new URL(window.location);
        url.searchParams.set('bookId', bookId);
        window.history.replaceState({}, '', url);
      }
      
      document.getElementById('bookSearch').value = '';
      document.getElementById('bookSuggestions').innerHTML = '';
    }

    function updateSelectedBooks() {
      const container = document.getElementById('selectedBooks');
      container.innerHTML = selectedBooks.map(book => `
        <div class="selected-book animate-slide-in-right">
          📖 ${book.info}
          <span class="remove-book" onclick="removeBook('${book.info}')">×</span>
        </div>
      `).join('');
    }

    function removeBook(bookInfo) {
      selectedBooks = selectedBooks.filter(book => book.info !== bookInfo);
      updateSelectedBooks();
      updateBookTitleField();
    }

    function updateBookTitleField() {
      document.getElementById('bookTitle').value = selectedBooks.map(book => book.info).join('\n');
    }

    function showAlert(type, message) {
      if (window.pickupValidator) {
        window.pickupValidator.showAlert(type, message);
      } else {
        alert(message);
      }
    }

    // Initialize all functionality
    async function initializePage() {
      // Load books and set up search
      await loadAvailableBooks();
      initializeBookSearch();
      
      // Set date constraints
      const dateField = document.getElementById('pickupDate');
      if (dateField) {
        const today = new Date().toISOString().split('T')[0];
        dateField.min = today;
        
        const maxDate = new Date();
        maxDate.setDate(maxDate.getDate() + 30);
        dateField.max = maxDate.toISOString().split('T')[0];
      }
      
      // Pre-select book from URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const bookId = urlParams.get('bookId');
      const bookTitle = urlParams.get('title');
      
      if (bookId && availableBooks.length) {
        const book = availableBooks.find(b => b.id === bookId);
        if (book) {
          selectBook(book.title, book.author, book.id);
        }
      } else if (bookTitle) {
        document.getElementById('bookTitle').value = decodeURIComponent(bookTitle);
      }
      
      // Auto-fill user data
      try {
        const userResponse = await fetch('/api/current-user');
        if (userResponse.ok) {
          const userData = await userResponse.json();
          if (userData.success && userData.user) {
            if (userData.user.username) document.getElementById('userName').value = userData.user.username;
            if (userData.user.email) document.getElementById('email').value = userData.user.email;
          }
        }
      } catch (error) {
        console.log('Could not load user data:', error);
      }
    }
    
    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', initializePage);

    // Save & Load Draft Functions
    function saveDraft() {
      const formData = {
        pickupType: document.getElementById('pickupType').value,
        bookTitle: document.getElementById('bookTitle').value,
        userName: document.getElementById('userName').value,
        email: document.getElementById('email').value,
        mobile: document.getElementById('mobile').value,
        pickupAddress: document.getElementById('pickupAddress').value,
        pickupDate: document.getElementById('pickupDate').value,
        pickupTime: document.getElementById('pickupTime').value,
        specialInstructions: document.getElementById('specialInstructions').value,
        selectedBooks: selectedBooks,
        timestamp: new Date().toISOString()
      };

      localStorage.setItem('pickupFormDraft', JSON.stringify(formData));
      showAlert('success', '💾 Draft saved successfully!');
    }

    function loadDraft() {
      const draft = localStorage.getItem('pickupFormDraft');
      if (!draft) return false;
      
      try {
        const formData = JSON.parse(draft);
        
        Object.keys(formData).forEach(key => {
          const element = document.getElementById(key);
          if (element && formData[key]) {
            element.value = formData[key];
          }
        });
        
        if (formData.selectedBooks) {
          selectedBooks = formData.selectedBooks;
          updateSelectedBooks();
        }
        
        showAlert('info', '📋 Draft loaded successfully!');
        return true;
      } catch (error) {
        console.error('Error loading draft:', error);
        return false;
      }
    }

    // Terms and conditions
    function showTerms() {
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.display = 'block';
      modal.innerHTML = `
        <div class="modal-content animate-slide-up">
          <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
          <h3 style="color: var(--primary-purple); margin-bottom: var(--space-lg);">Terms and Conditions</h3>
          <div style="max-height: 60vh; overflow-y: auto; color: var(--gray-600); line-height: 1.8;">
            <h4>Pickup Service Terms:</h4>
            <ul style="margin: var(--space-md) 0; padding-left: var(--space-lg);">
              <li>Pickup requests are subject to book availability</li>
              <li>Please be available at the specified time slot</li>
              <li>Books should be in good, readable condition</li>
              <li>Cancellation requires 24 hours advance notice</li>
              <li>Contact support for any pickup-related issues</li>
              <li>Service may be suspended during extreme weather</li>
            </ul>
            <h4>User Responsibilities:</h4>
            <ul style="margin: var(--space-md) 0; padding-left: var(--space-lg);">
              <li>Provide accurate pickup address and contact details</li>
              <li>Ensure someone is available for book collection</li>
              <li>Handle books with care during the pickup process</li>
            </ul>
          </div>
          <div style="text-align: center; margin-top: var(--space-lg);">
            <button class="btn btn-primary" onclick="this.parentElement.parentElement.remove()">I Understand</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    // Check for saved draft on page load and offer to load it
    function checkForDraft() {
      const draft = localStorage.getItem('pickupFormDraft');
      if (draft) {
        try {
          const formData = JSON.parse(draft);
          const draftAge = new Date() - new Date(formData.timestamp);
          const daysOld = Math.floor(draftAge / (1000 * 60 * 60 * 24));
          
          if (daysOld < 7) { // Only offer drafts less than a week old
            if (confirm(`📋 You have a saved draft from ${daysOld === 0 ? 'today' : daysOld + ' days ago'}. Load it?`)) {
              loadDraft();
            }
          } else {
            // Clean up old drafts
            localStorage.removeItem('pickupFormDraft');
          }
        } catch (error) {
          localStorage.removeItem('pickupFormDraft');
        }
      }
    }

    // Initialize everything when page loads
    document.addEventListener('DOMContentLoaded', function() {
      // Check for and offer to load saved drafts
      setTimeout(checkForDraft, 1000);
    });

    // Copy Tracking ID function
    function copyTrackingId() {
      const trackingId = window.currentTrackingId || document.getElementById('trackingIdDisplay')?.textContent;
      if (!trackingId) {
        showAlert('error', 'No tracking ID found to copy');
        return;
      }
      
      if (navigator.clipboard && window.isSecureContext) {
        // Use modern clipboard API
        navigator.clipboard.writeText(trackingId).then(() => {
          showAlert('success', '📋 Tracking ID copied to clipboard!');
        }).catch(() => {
          fallbackCopyText(trackingId);
        });
      } else {
        fallbackCopyText(trackingId);
      }
    }
    
    // Fallback copy function for older browsers
    function fallbackCopyText(text) {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.opacity = '0';
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      
      try {
        document.execCommand('copy');
        showAlert('success', '📋 Tracking ID copied to clipboard!');
      } catch (err) {
        showAlert('error', 'Failed to copy tracking ID. Please copy it manually.');
      }
      
      document.body.removeChild(textArea);
    }
    
    // Track Pickup function
    function trackPickup() {
      const trackingId = window.currentTrackingId || document.getElementById('trackingIdDisplay')?.textContent;
      if (!trackingId) {
        showAlert('error', 'No tracking ID found');
        return;
      }
      
      window.location.href = `/pickup-track?id=${encodeURIComponent(trackingId)}`;
    }
    
    console.log('✅ Enhanced pickup form with theme loaded successfully!');
  </script>
  
  <!-- Enhanced Chatbot Script -->
  <script src="/js/chatbot.js"></script>
</body>
</html>
